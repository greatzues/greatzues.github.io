<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" >
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
  <title>深度解析rn知乎日报 | zues blog</title>
  <meta name="description" content="" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" type="text/css" href="/css/screen.css" />
  <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic|Open+Sans:700,400" />

  <meta name="generator" content="zues blog">

  
  
  <link rel="alternate" type="application/atom+xml" title="Atom 0.3" href="atom.xml">
  
  

  
</head>


<body class="post-template">

  <header class="site-head"  style="background-image: url(http://pic1.win4000.com/wallpaper/b/4fcec6ce626d2.jpg)" >
    <div class="vertical">
        <div class="site-head-content inner">
             <a class="blog-logo" href="/"><img src="//blog.ghost.org/content/images/2013/Nov/bloglogo_1-1.png" alt="Blog Logo"/></a> 
            <h1 class="blog-title">zues blog</h1>
            <h2 class="blog-description"></h2>
        </div>
    </div>
</header>
  

<main class="content" role="main">
  <article class="post">
    <span class="post-meta">
      <time datetime="2016-08-22T00:25:55.000Z" itemprop="datePublished">
          2016-08-22
      </time>
    
    
    | 
    <a href='/tags/react-native/'>react-native</a>
    
    
</span>
    <h1 class="post-title">深度解析rn知乎日报</h1>
    <section class="post-content">
      <h2 id="推荐："><a href="#推荐：" class="headerlink" title="推荐："></a>推荐：</h2><hr>
<p>文章的开始之前我要先推荐一篇博客，写得非常清晰，笔者看完瞬间觉得逻辑清晰了很多，献上地址：<a href="http://codecloud.net/11084.html" target="_blank" rel="external">React 组件构造方法: ES5 (createClass) 还是 ES6 (class)？ | 程序员的资料库</a>。</p>
<h2 id="正文：index-android-js"><a href="#正文：index-android-js" class="headerlink" title="正文：index.android.js"></a>正文：index.android.js</h2><hr>
<p>首先看到入口<code>index.android.js</code>,这里是用ES5写的代码，在ES6中默认是使用严格方式，因此这里的ues strict在ES6中就可以省略了。然后是ES5以前导入其他函数的语法，ES6就使用import关键字来做同样的事情了。好了，后面肯定还有很多ES5的语法，但是暂时不用理了，因为这对于代码阅读没有多大的影响。</p>
<p>接着是声明一个<code>_navigator</code>变量，编写安卓手机物理返回键的事件监听，判断是否在此页面之前还有导航页，如果存在的话就使用<code>pop()</code>方法返回，返回true表示执行这个物理键操作。</p>
<p>然后是入口类<code>RCTZhiHuDaily</code>,一开始看到的是mixins,这个暂时不知道是什么，先不管后面用到的时候再回头说。那现在就开始接触组件的生命周期了：</p>
<blockquote>
<ul>
<li>getInitialState: 获得初始化组件状态，只调用一次，在ES6中被构造函数取代。</li>
<li>componentWillMount：组件将要加载，只调用一次</li>
<li>componentDidMount：组件加载完成并显示出来了，也就是完成了一次绘制，只调用一次</li>
<li>render：绘制组件，可能调用多次</li>
</ul>
</blockquote>
<p>可以看到在<code>componentDidMount</code>方法中设置了一个定时器，里面有一个开关，应该是启动页轮播图的开关，不过经过我翻译这个单词（译为“溅”）之后就不这么想了，肯定不是轮播图的，因为这个单词有个组合splash screen，译为启动页面.</p>
<p><code>RouteMapper</code>函数：相当于路由的函数，接收route，navigationOperations，onComponentRef三个参数，将传进去的onComponentRef赋值给_navigator,判断传进去的页面name，假如是home，就返回MainScreen组件，假如是story，就返回详情页StoryScreen，并且通过组件通信传递文章详情，两个返回的组件都有一个同样的属性那就是navigator，毋庸置疑，那肯定就是在路由中传递的组件Component了。</p>
<p>getInitialState函数：在组件初始化的时候将状态的成员splashed开关设为false</p>
<p>onActionSelected函数：没有处理方法</p>
<p>render函数：判断假如splash为true的时候返回启动页面initialRoute的name为home，结合上面的RouteMapper函数，可以知道此时会返回一个MainScreen组件，并且在render属性也明确了路由函数是<code>this.RouteMapper</code>。</p>
<p>最后是样式，flexDirections为column表示排列为竖直，如果是row则是水平。</p>
<p>分析到这里的时候开始有点糊涂了，为什么要一开始getInitialState要将splashed设为false，然后又在componentDidMount放一个定时器将splashed改为true,直接将其设为true不就好了吗。先去看看SplashScreen和MainScreen，回头再来补充。<br>》————–<strong><em>我是补充</em></strong>——————-》</p>
<blockquote>
<p>果然和我想的一样，首先是在渲染的时候进入一个动画的启动导航页，页面只有一幅图片，并且通过动画缩小的特效来做的引导页，然后在渲染完成之后通知<code>componentDidMount</code>函数，在<code>componentDidMount</code>函数里面设置定时时间，之后执行<code>setState</code>方法跳转到首页，哈哈，特效挺漂亮的。</p>
</blockquote>
<p>另外这里还有一个疑问就是setTimeout和setInterval的区别，setTimeout是在指定延迟时间去执行一次表达式，仅执行一次，而setInterval则是每隔指定的时间就执行一次表达式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Sample React Native App</span><br><span class="line"> * https://github.com/facebook/react-native</span><br><span class="line"> */</span><br><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">var React = require(&apos;react-native&apos;);</span><br><span class="line">//import React from &apos;react-native&apos;;</span><br><span class="line">var &#123;</span><br><span class="line">  AppRegistry,</span><br><span class="line">  BackAndroid,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  Navigator,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  ToolbarAndroid,</span><br><span class="line">  ToastAndroid,</span><br><span class="line">&#125; = React;</span><br><span class="line">var SplashScreen = require(&apos;./SplashScreen&apos;);</span><br><span class="line">var MainScreen = require(&apos;./MainScreen&apos;);</span><br><span class="line">var StoryScreen = require(&apos;./StoryScreen&apos;);</span><br><span class="line">var ToolbarAndroid = require(&apos;ToolbarAndroid&apos;);</span><br><span class="line">var TimerMixin = require(&apos;react-timer-mixin&apos;);</span><br><span class="line"></span><br><span class="line">var _navigator;</span><br><span class="line">BackAndroid.addEventListener(&apos;hardwareBackPress&apos;, () =&gt; &#123;</span><br><span class="line">  if (_navigator &amp;&amp; _navigator.getCurrentRoutes().length &gt; 1) &#123;</span><br><span class="line">    _navigator.pop();</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var RCTZhiHuDaily = React.createClass(&#123;</span><br><span class="line">  mixins: [TimerMixin],</span><br><span class="line">  componentDidMount: function() &#123;</span><br><span class="line">    this.setTimeout(</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        this.setState(&#123;splashed: true&#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      2000,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  RouteMapper: function(route, navigationOperations, onComponentRef) &#123;</span><br><span class="line">    _navigator = navigationOperations;</span><br><span class="line">    if (route.name === &apos;home&apos;) &#123;</span><br><span class="line">      return (</span><br><span class="line">        &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">          &lt;MainScreen navigator=&#123;navigationOperations&#125;/&gt;</span><br><span class="line">        &lt;/View&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125; else if (route.name === &apos;story&apos;) &#123;</span><br><span class="line">      return (</span><br><span class="line">        &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">          &lt;StoryScreen</span><br><span class="line">            style=&#123;&#123;flex: 1&#125;&#125;</span><br><span class="line">            navigator=&#123;navigationOperations&#125;</span><br><span class="line">            story=&#123;route.story&#125; /&gt;</span><br><span class="line">        &lt;/View&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      splashed: false,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  onActionSelected: function(position) &#123;</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    if (this.state.splashed) &#123;</span><br><span class="line">      var initialRoute = &#123;name: &apos;home&apos;&#125;;</span><br><span class="line">      return (</span><br><span class="line">        &lt;Navigator</span><br><span class="line">          style=&#123;styles.container&#125;</span><br><span class="line">          initialRoute=&#123;initialRoute&#125;</span><br><span class="line">          configureScene=&#123;() =&gt; Navigator.SceneConfigs.FadeAndroid&#125;</span><br><span class="line">          renderScene=&#123;this.RouteMapper&#125;</span><br><span class="line">        /&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      return (</span><br><span class="line">        &lt;SplashScreen /&gt;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    flexDirection: &apos;column&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  instructions: &#123;</span><br><span class="line">    textAlign: &apos;center&apos;,</span><br><span class="line">    color: &apos;#333333&apos;,</span><br><span class="line">    marginBottom: 5,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">AppRegistry.registerComponent(&apos;RCTZhiHuDaily&apos;, () =&gt; RCTZhiHuDaily);</span><br></pre></td></tr></table></figure></p>
<h2 id="SplashScreen-js"><a href="#SplashScreen-js" class="headerlink" title="SplashScreen.js"></a>SplashScreen.js</h2><hr>
<p>根据index.android.js的生命周期执行顺序，接下来需要看的是SplashScreen.js。</p>
<p>头部的导入几乎可以忽略，不过可以提一下<code>var WINDOW_WIDTH = Dimensions.get(&#39;window&#39;).width;</code>这个是获取设备窗口的宽度，可以很灵活的适配手机视图。</p>
<p>然后就是SplashScreen类了，简单浏览一下代码发现原来这里只是简单的展示一副图片并且使用了动画效果，看来这一页是大多数app的引导页，这样我就可以去补充刚刚上面的疑问了。</p>
<p><strong>fetchData函数</strong>：repository.getCover()这个是DataRepository里面的一个函数，return返回<code>_safeStorage(KEY_COVER)</code>,其中KEY_COVER的值为@Cover，是用来持久保存启动页的动画封面。</p>
<p>传进去一个key值到_safeStorage中去，该方法通过<code>new</code>来调用<code>Promise</code>的构造器返回一个实例化之后的promise对象，这个对象可以使用<code>promise.then()</code>方法。</p>
<p>可以看到传进去之后的key被<code>AsyncStorage</code>的<code>static getItem(key: string, callback?: ?(error: ?Error, result: ?string) =&gt; void)</code>所使用，这个方法也返回一个promise对象，将get到的item作为一个变量retData通过<code>promise的resolve</code>传出去给then方法使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DataRepository.prototype.getCover = function() &#123;</span><br><span class="line">  return this._safeStorage(KEY_COVER);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataRepository.prototype._safeStorage = function(key: string) &#123; </span><br><span class="line">  return new Promise((resolve, reject) =&gt; &#123;</span><br><span class="line">    AsyncStorage.getItem(key, (error, result) =&gt; &#123;</span><br><span class="line">      var retData = JSON.parse(result);</span><br><span class="line">      if (error) &#123;</span><br><span class="line">        console.error(error);</span><br><span class="line">        resolve(null);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        resolve(retData);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>接下来就是<code>repository.getCover().then((result) =&gt;{...}</code>的操作了,then函数能像先知一样对可能发生的结果进行不同的回调处理，如果是resolve（成功）的话就会调用<code>onFulfilled</code>方法,如果是reject(失败)的话就会被catch到error，触发<code>onRejected</code>方法，因为下面的代码都是箭头函数，因此我们不能明显看到那两个方法的名字。</p>
<p>在getCover执行完之后就开始执行的是<code>repository.updateCover();</code>我们需要倒回去看一下这个函数的实现，下面是这个方法的代码，需要贴出来的是<code>API_COVER_URL</code>,这个作为fetch的参数，后面还有then，说明是通过get方式获取到response，得到response.json，并且继续通过then方法将返回的json数据作为then的参数responseData传进去，方法里面使用AsyncStorage.setItem将其用键值对的形式永久保存起来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DataRepository.prototype.updateCover = function() &#123;</span><br><span class="line">  fetch(API_COVER_URL)</span><br><span class="line">    .then((response) =&gt; response.json())</span><br><span class="line">    .then((responseData) =&gt; &#123;</span><br><span class="line">      AsyncStorage.setItem(KEY_COVER, JSON.stringify(responseData));</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch((error) =&gt; &#123;</span><br><span class="line">      console.error(error);</span><br><span class="line">    &#125;)</span><br><span class="line">    .done();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>getInitialState函数：返回state的两个变量<code>cover</code>为null和<code>bounceValue</code>为<code>new Animated.Value(1)</code>，其中cover肯定是后面用来装载启动页api对应的图片uri，详情可以看到<code>fetchData</code>里面的<code>setState</code>和<code>render</code>里面的<code>uri: this.state.cover.img</code>，然后<code>bounceValue</code>变量存储<code>new Animated.Value(1)</code>是rn的animated里面常见的声明实例用法了（<a href="">如果不明白请看我上一篇博客</a>），因为这里的效果是timing缩放，所以这里参数中的1表示的图像的原始形状。</p>
<p>componentDidMount函数：这个函数在render之后执行，这里的代码表示这个函数首先会执行fetchData函数，接着执行setValue又是为原型，开启动画<code>Animated.timing(animateValue, conf&lt;Object&gt;)</code>,画面再次渲染。</p>
<p>render函数：局部变量img和text，判断如果cover的api存在就分别用来存储cover.img和cover.text（至于为什么会有img和text就要自己打开api去看一下里面的json数据了），如果不存在的话img就为require(‘image!splash’),哈哈，这句没看懂，文件夹里面也没有image文件夹啊而且感叹号也不知道是什么意思。接着就是return回<animated.image>,这个动画参数需要有source（图片资源），已经将动画原始值绑定到style里面去，也就是这里的<code>transform:[{scale: this.state.bounceValue}]</code>,transform是转换的意思，scale是规模比例。<text>放{text}文字。</text></animated.image></p>
<h3 id="这里是完整代码SplashScreen-js"><a href="#这里是完整代码SplashScreen-js" class="headerlink" title="这里是完整代码SplashScreen.js"></a>这里是完整代码SplashScreen.js</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">var React = require(&apos;react-native&apos;);</span><br><span class="line">var &#123;</span><br><span class="line">  AsyncStorage,</span><br><span class="line">  Image,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  Dimensions,</span><br><span class="line">&#125; = React;</span><br><span class="line"></span><br><span class="line">var Animated = require(&apos;Animated&apos;);</span><br><span class="line"></span><br><span class="line">var WINDOW_WIDTH = Dimensions.get(&apos;window&apos;).width;</span><br><span class="line"></span><br><span class="line">var DataRepository = require(&apos;./DataRepository&apos;);</span><br><span class="line">var repository = new DataRepository();</span><br><span class="line"></span><br><span class="line">var SplashScreen = React.createClass(&#123;</span><br><span class="line">  fetchData: function() &#123;</span><br><span class="line">    repository.getCover()</span><br><span class="line">      .then((result) =&gt; &#123;</span><br><span class="line">        if (result)&#123;</span><br><span class="line">          this.setState(&#123;cover: result&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      .catch((error) =&gt; &#123;</span><br><span class="line">        console.error(error);</span><br><span class="line">      &#125;)</span><br><span class="line">      .done();</span><br><span class="line">    repository.updateCover();</span><br><span class="line">  &#125;,</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return &#123;</span><br><span class="line">      cover: null,</span><br><span class="line">      bounceValue: new Animated.Value(1),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  componentDidMount: function() &#123;</span><br><span class="line">    this.fetchData();</span><br><span class="line">    this.state.bounceValue.setValue(1);</span><br><span class="line">    Animated.timing(</span><br><span class="line">      this.state.bounceValue,</span><br><span class="line">      &#123;</span><br><span class="line">        toValue: 1.2,</span><br><span class="line">        duration: 5000,</span><br><span class="line">      &#125;</span><br><span class="line">    ).start();</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    var img, text;</span><br><span class="line">    if (this.state.cover) &#123;</span><br><span class="line">      img = &#123;uri: this.state.cover.img&#125;;</span><br><span class="line">      text = this.state.cover.text;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      img = require(&apos;image!splash&apos;);</span><br><span class="line">      text = &apos;&apos;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return(</span><br><span class="line">      &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">        &lt;Animated.Image</span><br><span class="line">          source=&#123;img&#125;</span><br><span class="line">          style=&#123;&#123;</span><br><span class="line">            flex: 1,</span><br><span class="line">            width: WINDOW_WIDTH,</span><br><span class="line">            height: 1,</span><br><span class="line">            transform: [</span><br><span class="line">              &#123;scale: this.state.bounceValue&#125;,</span><br><span class="line">            ]</span><br><span class="line">          &#125;&#125; /&gt;</span><br><span class="line">        &lt;Text style=&#123;styles.text&#125;&gt;</span><br><span class="line">            &#123;text&#125;</span><br><span class="line">        &lt;/Text&gt;</span><br><span class="line">        &lt;Image style=&#123;styles.logo&#125; source=&#123;require(&apos;image!splash_logo&apos;)&#125; /&gt;</span><br><span class="line">      &lt;/View&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    flexDirection: &apos;column&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  cover: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    width: 200,</span><br><span class="line">    height: 1,</span><br><span class="line">  &#125;,</span><br><span class="line">  logo: &#123;</span><br><span class="line">    resizeMode: &apos;contain&apos;,</span><br><span class="line">    position: &apos;absolute&apos;,</span><br><span class="line">    left: 0,</span><br><span class="line">    right: 0,</span><br><span class="line">    bottom: 30,</span><br><span class="line">    height: 54,</span><br><span class="line">    backgroundColor: &apos;transparent&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  text: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    fontSize: 16,</span><br><span class="line">    textAlign: &apos;center&apos;,</span><br><span class="line">    color: &apos;white&apos;,</span><br><span class="line">    position: &apos;absolute&apos;,</span><br><span class="line">    left: 0,</span><br><span class="line">    right: 0,</span><br><span class="line">    bottom: 10,</span><br><span class="line">    backgroundColor: &apos;transparent&apos;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports = SplashScreen;</span><br></pre></td></tr></table></figure>
<h2 id="MainScreen-android-js"><a href="#MainScreen-android-js" class="headerlink" title="MainScreen.android.js"></a>MainScreen.android.js</h2><hr>
<p>这里的代码相对比较少，导入那一块因为现在已经是ES6，有新的语法糖，可以使用import关键字导入。类外部声明了一个全局变量<code>DRAWER_REF = &#39;drawer&#39;</code>,<code>DRAWER_WIDTH_LEFT = 56</code>以及<code>toolbar</code>的图片和展示的一些全局设置，ok，开始分析类里面的方法：<br>构造函数getInitialState(ES6是constructor写法有所不同)：声明一个state的成员变量theme为null。</p>
<p>onSelectTheme函数：这个方法用来选择主题，方法传入一个theme，使用ref调用DRAWER_REF对应的抽屉的close方法（在ES6中应该这样使用<code>this.ref.DRAWER_REF.closeDrawer()</code>），将抽屉关闭，并且将传进去的参数theme赋值给state的theme变量。</p>
<p>_renderNavigationView函数：返回jsx语法的一个<themelist>组件，将this.onSelectTheme方法传进去其属性onSelectItem中，一旦onSelectItem触发，启动this.onSelectTheme方法。</themelist></p>
<p>onRefresh函数：调用onSelectTheme函数，用来刷新主题。</p>
<p>onRefreshFinish函数：</p>
<p>render函数：这里用局部变量draw存储<themelist>组件，并且将其属性onSelectItem触发的时候调用onSelectTheme回调函数。然后返回一个<a href="https://github.com/root-two/react-native-drawer" target="_blank" rel="external">react-native-drawer</a>库的一个实例<code>&lt;Drawer&gt;</code>组件。这里的属性比较多，一开始是ref用来标识，然后就是`openDrawerOffset</themelist></p>
<blockquote>
<p>这里的属性比较多，一开始是ref用来标识，然后就是<code>openDrawerOffset (Number|Function)</code>这个是定义抽屉当被打开的手势偏移量，参数可以是像素也可以是整数，也可以是一个方法。<code>panCloseMask (Number)</code>,鉴于英文水平不好，google上好像也找不到解释，暂时先不理[破涕为笑.jpg]。然后就是content (React.Component)根据意思可以知道也就是抽屉菜单。</p>
</blockquote>
<p>然后被这个抽屉函数包裹的当然就是知乎日报里面的list了，所以这个<storieslist>就是一开始启动动画过渡之后的知乎新闻列表，而属性的this.state.theme就是每一个item的样式，因为点击每一个新闻都可以跳转到详情页，所以navigator就是导航器，经过index.android.js的路由然后跳转到对应的页面。</storieslist></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">&apos;use strict&apos;;</span><br><span class="line"></span><br><span class="line">var React = require(&apos;react-native&apos;);</span><br><span class="line">var &#123;</span><br><span class="line">  AsyncStorage,</span><br><span class="line">  Image,</span><br><span class="line">  StyleSheet,</span><br><span class="line">  Text,</span><br><span class="line">  View,</span><br><span class="line">  DrawerLayoutAndroid,</span><br><span class="line">  ToolbarAndroid,</span><br><span class="line">  ToastAndroid,</span><br><span class="line">  BackAndroid,</span><br><span class="line">  TouchableOpacity,</span><br><span class="line">  Dimensions,</span><br><span class="line">&#125; = React;</span><br><span class="line"></span><br><span class="line">var Drawer = require(&apos;react-native-drawer&apos;);</span><br><span class="line">var StoriesList = require(&apos;./StoriesList&apos;);</span><br><span class="line">var ThemesList = require(&apos;./ThemesList&apos;);</span><br><span class="line">var SwipeRefreshLayoutAndroid = require(&apos;./SwipeRereshLayout&apos;);</span><br><span class="line"></span><br><span class="line">var DRAWER_REF = &apos;drawer&apos;;</span><br><span class="line">var DRAWER_WIDTH_LEFT = 56;</span><br><span class="line">var toolbarActions = [</span><br><span class="line">  &#123;title: &apos;提醒&apos;, icon: require(&apos;image!ic_message_white&apos;), show: &apos;always&apos;&#125;,</span><br><span class="line">  &#123;title: &apos;夜间模式&apos;, show: &apos;never&apos;&#125;,</span><br><span class="line">  &#123;title: &apos;设置选项&apos;, show: &apos;never&apos;&#125;,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var MainScreen = React.createClass(&#123;</span><br><span class="line">  getInitialState: function() &#123;</span><br><span class="line">    return (&#123;</span><br><span class="line">      theme: null,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  onSelectTheme: function(theme) &#123;</span><br><span class="line">    this.refs[DRAWER_REF].closeDrawer();</span><br><span class="line">    this.setState(&#123;theme: theme&#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  _renderNavigationView: function() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;ThemesList</span><br><span class="line">        onSelectItem=&#123;this.onSelectTheme&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line">  onRefresh: function() &#123;</span><br><span class="line">    this.onSelectTheme(this.state.theme);</span><br><span class="line">  &#125;,</span><br><span class="line">  onRefreshFinish: function() &#123;</span><br><span class="line">    this.swipeRefreshLayout &amp;&amp; this.swipeRefreshLayout.finishRefresh();</span><br><span class="line">  &#125;,</span><br><span class="line">  render: function() &#123;</span><br><span class="line">    var title = this.state.theme ? this.state.theme.name : &apos;首页&apos;;</span><br><span class="line">    return (</span><br><span class="line">      &lt;DrawerLayoutAndroid</span><br><span class="line">        ref=&#123;DRAWER_REF&#125;</span><br><span class="line">        drawerWidth=&#123;Dimensions.get(&apos;window&apos;).width - DRAWER_WIDTH_LEFT&#125;</span><br><span class="line">        keyboardDismissMode=&quot;on-drag&quot;</span><br><span class="line">        drawerPosition=&#123;DrawerLayoutAndroid.positions.Left&#125;</span><br><span class="line">        renderNavigationView=&#123;this._renderNavigationView&#125;&gt;</span><br><span class="line">        &lt;View style=&#123;styles.container&#125;&gt;</span><br><span class="line">          &lt;ToolbarAndroid</span><br><span class="line">            navIcon=&#123;require(&apos;image!ic_menu_white&apos;)&#125;</span><br><span class="line">            title=&#123;title&#125;</span><br><span class="line">            titleColor=&quot;white&quot;</span><br><span class="line">            style=&#123;styles.toolbar&#125;</span><br><span class="line">            actions=&#123;toolbarActions&#125;</span><br><span class="line">            onIconClicked=&#123;() =&gt; this.refs[DRAWER_REF].openDrawer()&#125;</span><br><span class="line">            onActionSelected=&#123;this.onActionSelected&#125; /&gt;</span><br><span class="line">          &lt;SwipeRefreshLayoutAndroid</span><br><span class="line">            ref=&#123;(swipeRefreshLayout) =&gt; &#123; this.swipeRefreshLayout = swipeRefreshLayout; &#125;&#125;</span><br><span class="line">            onSwipeRefresh=&#123;this.onRefresh&#125;&gt;</span><br><span class="line">            &lt;StoriesList theme=&#123;this.state.theme&#125; navigator=&#123;this.props.navigator&#125;</span><br><span class="line">              onRefreshFinish=&#123;this.onRefreshFinish&#125;/&gt;</span><br><span class="line">          &lt;/SwipeRefreshLayoutAndroid&gt;</span><br><span class="line">        &lt;/View&gt;</span><br><span class="line">      &lt;/DrawerLayoutAndroid&gt;</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">var styles = StyleSheet.create(&#123;</span><br><span class="line">  container: &#123;</span><br><span class="line">    flex: 1,</span><br><span class="line">    flexDirection: &apos;column&apos;,</span><br><span class="line">    backgroundColor: &apos;#FAFAFA&apos;,</span><br><span class="line">  &#125;,</span><br><span class="line">  toolbar: &#123;</span><br><span class="line">    backgroundColor: &apos;#00a2ed&apos;,</span><br><span class="line">    height: 56,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">module.exports = MainScreen;</span><br></pre></td></tr></table></figure>
<p>正常需要展示给用户看的只有四个主要页面，也就是<splashscreen>, <storyscreen>, <mainscreen>, 以及抽屉的菜单页面<themelist><br>因此我觉得应该把其他剩余的小组件分析完再来解析主要的这四个，也就是从量变到质变的过程。ok，不说太多，开始：</themelist></mainscreen></storyscreen></splashscreen></p>
<h2 id="DataRepository-js"><a href="#DataRepository-js" class="headerlink" title="DataRepository.js"></a>DataRepository.js</h2><hr>
<p>这个类是所有页面需要的数据的仓库，里面聚集各种借口和网络请求，所以这个类需要存储很多东西，说到存储就当然少不了AsyncStorage，可以永久保存数据到手机内。因此一开始就声明了全局变量AsyncStorage。</p>
<p>接下来是各种接口url，以及对应的键（string）来存储对应的uri值（string）。接着就是创建显示日期的parseDateFromYYYYMMdd方法，需要传进去一个str，判断假如传进去为null则返回一个new Date()，并且会触发下面的Date子函数yyyymmdd,该函数返回当日的日期，如果有参数的话则返回一个new Date(YYYYMMdd)，显示的是参数里面的日期。</p>
<p>然后看到DataRepository方法，很明显这里是创建一个实例化的DataRepository对象，并且<code>DataRepository.instance = this;</code>来调用类暴露的所有方法，这是明显的单例模式。这里开始就要往DataRepository类里面去看了。</p>
<p>_safeStorage函数：永久保存对局，传入string类型的键，返回一个Promise构造函数，异步执行AsyncStorage的getItem方法，使用这个方法能够取出key对应的value。看到参数里面有<code>(error, result)</code>这个是观法那个大部分函数的使用的一个方式，加入没有出现error的时候就会将错误信息赋给error，如果正确执行的话就会将结果赋值给result，为什么会下面一句JSON.parse(jsonInfo),因为在我们保存的时候是用的Fetch直接将api的内容保存的，而api里面全部都是以json数据保存的，所以内容肯定就是json数据了。</p>
<p>_safeFetch函数：传入目标url</p>

    </section>
    <footer class="post-footer">
      <section class="author">
    <h4>漏雨</h4>
    <p>生活不只是眼前的苟且，还有程序和代码，诗和远方也不错</p>
</section>
      <section class="share">
    <h4>Share this post</h4>
    <a class="icon-twitter" href="http://twitter.com/share?url=http://yoursite.com/2016/08/22/深度解析rn知乎日报/"
       onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
        <span class="hidden">Twitter</span>
    </a>
    <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/2016/08/22/深度解析rn知乎日报/"
       onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
        <span class="hidden">Facebook</span>
    </a>
    <a class="icon-google-plus" href="https://plus.google.com/share?url=http://yoursite.com/2016/08/22/深度解析rn知乎日报/"
       onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
        <span class="hidden">Google+</span>
    </a>
</section>
    </footer>
  </article>
  <nav class="pagination" role="pagination">
    
    <a class="newer-posts" href="/2016/08/28/项目感想/">
        ← 项目感想
    </a>
    
    <span class="page-number">•</span>
    
    <a class="older-posts" href="/2016/08/20/react-native学习笔记7/">
        react-native学习笔记7 →
    </a>
    
</nav>
  <div id="comment" class="comments-area">
    <h1 class="title"><a href="#disqus_comments" name="disqus_comments">Comments</a></h1>

    
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
    
</div>
</main>


  
<footer class="site-footer">
  
  <a class="subscribe icon-feed" href="atom.xml"><span class="tooltip">Subscribe!</span></a>
  
  <div class="inner">
     <section class="copyright">All content copyright <a href="/">zues blog</a> &copy; 2014 &bull; All rights reserved.</section>
     <section class="poweredby">Proudly published with <a class="icon-ghost" href="http://zespia.tw/hexo/">Hexo</a></section>
  </div>
</footer>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>

<script type="text/javascript" src="/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/js/index.js"></script>



<script type="text/javascript">
    var disqus_shortname = 'SnG53qEhZd';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
